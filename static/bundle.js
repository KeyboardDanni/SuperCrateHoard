(()=>{"use strict";var t,e,i={},s={};function r(t){var e=s[t];if(void 0!==e)return e.exports;var n=s[t]={exports:{}};return i[t](n,n.exports,r),n.exports}e=Object.getPrototypeOf?t=>Object.getPrototypeOf(t):t=>t.__proto__,r.t=function(i,s){if(1&s&&(i=this(i)),8&s)return i;if("object"==typeof i&&i){if(4&s&&i.__esModule)return i;if(16&s&&"function"==typeof i.then)return i}var n=Object.create(null);r.r(n);var a={};t=t||[null,e({}),e([]),e(e)];for(var h=2&s&&i;"object"==typeof h&&!~t.indexOf(h);h=e(h))Object.getOwnPropertyNames(h).forEach((t=>a[t]=()=>i[t]));return a.default=()=>i,r.d(n,a),n},r.d=(t,e)=>{for(var i in e)r.o(e,i)&&!r.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},r.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};class n{constructor(t){this.imageElement=new Image,this.imageElement.loading="eager",n.numLoading++,this.imageElement.onload=()=>{n.numLoading--},this.imageElement.onerror=()=>{n.errors.push(`Image failed to load: "${t}"`),n.numLoading--},this.imageElement.src=t}image(){return this.imageElement}static itemsLoading(){return this.numLoading}static itemErrors(){return this.errors}}n.numLoading=0,n.errors=[];class a{constructor(t){if(!a.dataCache[t]){const e=new n(t);a.dataCache[t]=e}this.pictureData=a.dataCache[t]}sharedData(){return this.pictureData}isLoaded(){return this.pictureData.image().complete}static allLoaded(){return n.itemsLoading()<=0&&n.itemErrors().length<=0}}a.dataCache={};class h{constructor(t,e,i,s){this.x=t,this.y=e,this.w=i,this.h=s}}class o{constructor(t){if(this.alreadyWarned={},this.mainCanvas=document.getElementById(t),!this.mainCanvas||!this.mainCanvas.getContext)throw new Error("Missing canvas");const e=this.mainCanvas.getContext("2d");if(!e)throw new Error("Could not create canvas context");this.drawingContext=e,document.addEventListener("keydown",(t=>{t.altKey&&"Enter"==t.code&&!t.repeat&&this.toggleFullscreen()}))}checkPictureLoaded(t){const e=t.sharedData().image().src;return!!t.isLoaded()||(this.alreadyWarned[e]||(this.alreadyWarned[e]=!0,console.warn(`Drawing unloaded picture: "${e}"`)),!1)}drawBackgroundColor(t,e,i,s=1){this.drawingContext.fillStyle=`rgb(${t}, ${e}, ${i}, ${s})`,this.drawingContext.fillRect(-1,-1,this.mainCanvas.width+2,this.mainCanvas.height+2)}drawPicture(t,e,i){this.checkPictureLoaded(t)&&this.drawingContext.drawImage(t.sharedData().image(),e,i)}drawSprite(t,e,i,s){this.checkPictureLoaded(t)&&this.drawingContext.drawImage(t.sharedData().image(),e.x,e.y,e.w,e.h,Math.round(i),Math.round(s),e.w,e.h)}drawText(t,e,i,s,r,n=-1){this.drawingContext.font=s,this.drawingContext.fillStyle=r;const a=this.drawingContext.measureText(" "),h=Math.ceil(1.1*(a.fontBoundingBoxAscent+a.fontBoundingBoxDescent));n>0&&(t=this.computeWordWrap(t,n));const o=t.split("\n");for(const t of o)this.drawingContext.fillText(t,e,i),i+=h}computeWordWrap(t,e){var i;let s="";const r=t.split(" ");let n=null!==(i=r[0])&&void 0!==i?i:"";for(let t=1;t<r.length;++t){const i=r[t];this.drawingContext.measureText(n+" "+i).width>e?(s+=n+"\n",n=i):n+=" "+i}return s+=n,s}toggleFullscreen(){document.fullscreenElement?document.exitFullscreen():this.mainCanvas.requestFullscreen({navigationUI:"hide"})}canvas(){return this.mainCanvas}context(){return this.drawingContext}}class c{constructor(){this.bindings=[],this.timeHeld=0}}class d{constructor(){this.heldKeys={},this.actions={},document.addEventListener("keydown",(t=>this.keyDownHandler(t))),document.addEventListener("keyup",(t=>this.keyUpHandler(t))),document.addEventListener("contextmenu",(t=>{t.preventDefault(),t.stopPropagation()}))}keyDownHandler(t){this.heldKeys[t.code]=!0}keyUpHandler(t){this.heldKeys[t.code]=!1}newFrame(){t:for(const t of Object.values(this.actions)){for(const e of t.bindings)if(!0===this.heldKeys[e]){t.timeHeld++;continue t}t.timeHeld=0}}addAction(t,e=[]){if(this.actions[t])throw new Error(`Action "${t}" already exists`);this.actions[t]=new c,this.bindAction(t,e)}bindAction(t,e){const i=this.actions[t];if(!i)throw new Error(`Action "${t}" doesn't exist`);for(const t of e)t in i.bindings||i.bindings.push(t)}clearActionBindings(t){const e=this.actions[t];if(!e)throw new Error(`Action "${t}" doesn't exist`);e.bindings=[]}timeHeld(t){const e=this.actions[t];return e?e.timeHeld:0}held(t){return this.timeHeld(t)>0}justPressed(t){return 1===this.timeHeld(t)}autoRepeat(t,e,i){const s=this.timeHeld(t);return 1===s||s>=e&&(s-e)%i==0}}class l{constructor(){this.tickLogic=[],this.drawLogic=[],this.tickLoaderLogic=[],this.drawLoaderLogic=[],this.waitForResources=!0}isLoaded(){if(this.waitForResources){if(n.itemsLoading()<=0&&n.itemErrors().length>0)throw new Error(function(t){if(t.length<=0)return"";let e="";for(const i of t)e+=i+"\n";return e.slice(0,-1)}(n.itemErrors()));return a.allLoaded()}return!0}tick(t){const e=this.isLoaded()?this.tickLogic:this.tickLoaderLogic;for(const i of e)i.tick(t,this)}draw(t,e){const i=this.isLoaded()?this.drawLogic:this.drawLoaderLogic;for(const s of i)s.draw(t,this,e)}addLogic(t){this.tickLogic.push(t),this.drawLogic.push(t)}addTickLogic(t){this.tickLogic.push(t)}addDrawLogic(t){this.drawLogic.push(t)}addTickLoaderLogic(t){this.tickLoaderLogic.push(t)}addDrawLoaderLogic(t){this.drawLoaderLogic.push(t)}}const w=1e3/60;class u{constructor(){this.timestamp=0,this.goodSamples=0,this.timings=[],this.lastGoodAverage=w}updateTimings(){const t=performance.now();if(this.timestamp<=0)return void(this.timestamp=t);const e=t-this.timestamp;this.timestamp=t,e>20.1||(this.timings.length>=60&&this.timings.shift(),this.timings.length>0&&(Math.abs(this.timings[this.timings.length-1]-e)>6||Math.abs(this.averageRateRaw()-e)>6?this.goodSamples=0:this.goodSamples+=1),this.timings.push(e))}averageRateRaw(){let t=0;for(const e of this.timings)t+=e;return t/this.timings.length}averageRate(){return this.hasEnoughSamples()&&(this.lastGoodAverage=this.averageRateRaw()),this.lastGoodAverage}shouldLerp(){const t=this.averageRate();return Math.abs(t-w)>1}hasEnoughSamples(){return this.goodSamples>60}reset(){this.timestamp=0,this.goodSamples=0,this.timings=[]}}class g{constructor(t){this.currentScene=new l,this.pendingSceneFunc=null,this.vsyncRate=new u,this.lastTick=performance.now(),this.tickQueue=0,this.framesSinceTickLag=0,this.doDraw=!1,this.doLerp=!1,this.running=!1,this.gameInput=new d,this.gameRenderer=new o(t)}run(){if(this.running)throw new Error("run() already called");this.running=!0,this.lastTick=performance.now(),this.tickQueue=0,requestAnimationFrame(this.timerUpdate.bind(this))}scene(){return this.currentScene}setScene(t){this.pendingSceneFunc=t}input(){return this.gameInput}renderer(){return this.gameRenderer}timerUpdate(){try{this.vsyncRate.updateTimings(),null!==this.pendingSceneFunc&&(this.currentScene=this.pendingSceneFunc(),this.pendingSceneFunc=null),this.updateTicks(),this.updateDraw(),requestAnimationFrame(this.timerUpdate.bind(this))}catch(t){const e=this.gameRenderer.canvas();let i="";i=t instanceof Error?`${t.name}\n${t.message}`:"Unknown error occurred.";const[s,r]=[32,32];for(const t of[[1,0],[-1,0],[0,-1],[0,1]])this.gameRenderer.drawText(i,s+t[0],r+t[1],"14px Consolas","rgb(0, 0, 0, 1.0)",e.width-64);throw this.gameRenderer.drawText(i,s,r,"14px Consolas","rgb(255, 255, 255, 1.0)",e.width-64),t}}updateTicks(){const t=performance.now();for(this.tickQueue+=t-this.lastTick,this.lastTick=t;this.tickQueue>=w;){this.gameInput.newFrame(),this.currentScene.tick(this),this.framesSinceTickLag++,this.doDraw=!0,this.tickQueue-=w;const e=performance.now();if(e-t>33.333333333333336){this.tickQueue=0,this.lastTick=e,this.framesSinceTickLag=0;break}}this.doLerp=this.vsyncRate.shouldLerp()&&this.framesSinceTickLag>=4}updateDraw(){if(!this.doDraw)return;let t;this.doLerp?t=this.tickQueue/w:(t=1,this.doDraw=!1),this.gameRenderer.drawBackgroundColor(0,0,0),this.currentScene.draw(this,t)}}const y=JSON.parse('{"wall":[{"x":0,"y":0,"w":32,"h":32},{"x":32,"y":0,"w":32,"h":32},{"x":64,"y":0,"w":32,"h":32},{"x":96,"y":0,"w":32,"h":32},{"x":128,"y":0,"w":32,"h":32},{"x":160,"y":0,"w":32,"h":32},{"x":192,"y":0,"w":32,"h":32},{"x":224,"y":0,"w":32,"h":32},{"x":0,"y":32,"w":32,"h":32},{"x":32,"y":32,"w":32,"h":32},{"x":64,"y":32,"w":32,"h":32},{"x":96,"y":32,"w":32,"h":32},{"x":128,"y":32,"w":32,"h":32},{"x":160,"y":32,"w":32,"h":32},{"x":192,"y":32,"w":32,"h":32},{"x":224,"y":32,"w":32,"h":32}],"floor":[{"x":0,"y":64,"w":32,"h":32},{"x":64,"y":64,"w":32,"h":32},{"x":128,"y":64,"w":32,"h":32},{"x":192,"y":64,"w":32,"h":32}],"dropzone":[{"x":32,"y":64,"w":32,"h":32},{"x":96,"y":64,"w":32,"h":32},{"x":160,"y":64,"w":32,"h":32},{"x":224,"y":64,"w":32,"h":32}],"bg":[{"x":0,"y":96,"w":32,"h":32},{"x":32,"y":96,"w":32,"h":32},{"x":64,"y":96,"w":32,"h":32},{"x":96,"y":96,"w":32,"h":32}],"playerDown":[{"x":0,"y":160,"w":32,"h":32},{"x":32,"y":160,"w":32,"h":32},{"x":64,"y":160,"w":32,"h":32}],"playerRight":[{"x":96,"y":160,"w":32,"h":32},{"x":128,"y":160,"w":32,"h":32},{"x":160,"y":160,"w":32,"h":32}],"playerLeft":[{"x":0,"y":192,"w":32,"h":32},{"x":32,"y":192,"w":32,"h":32},{"x":64,"y":192,"w":32,"h":32}],"playerUp":[{"x":96,"y":192,"w":32,"h":32},{"x":128,"y":192,"w":32,"h":32},{"x":160,"y":192,"w":32,"h":32},{"x":192,"y":192,"w":32,"h":32}],"playerHmm":{"x":192,"y":160,"w":32,"h":32},"playerWin":{"x":224,"y":192,"w":32,"h":32},"crate":[{"x":0,"y":224,"w":32,"h":32},{"x":32,"y":224,"w":32,"h":32},{"x":64,"y":224,"w":32,"h":32},{"x":96,"y":224,"w":32,"h":32}],"confetti":[{"x":224,"y":160,"w":8,"h":8},{"x":240,"y":160,"w":8,"h":8},{"x":232,"y":168,"w":8,"h":8},{"x":248,"y":168,"w":8,"h":8},{"x":224,"y":176,"w":8,"h":8}]}'),p=r.t(y,2);class m{constructor(t){this.canvas=null,this.scroll=0,this.scrollSpeed=t,this.image=new a("res/GameAtlas.png")}createCanvas(){if(this.canvas||!a.allLoaded())return;const t=[],e=p.bg[0].w,i=p.bg[0].h;for(let e=0;e<1024;++e)t.push(Math.random()<.3);const s=new OffscreenCanvas(32*e,32*i),r=s.getContext("2d");if(!r)throw new Error("Offscreen canvas context failed");const n=Math.ceil(s.width/e)+1,h=Math.ceil(s.height/i)+1;for(let e=0;e<h;++e)for(let i=0;i<n;++i){let s=(i+e)%2?1:0;const[n,a]=[i%32,e%32];t[n+32*a]&&(s+=2);const h=p.bg[s];r.drawImage(this.image.sharedData().image(),h.x,h.y,h.w,h.h,i*h.w,e*h.h,h.w,h.h)}this.canvas=s}tick(t,e){this.scroll+=this.scrollSpeed}draw(t,e,i){if(this.createCanvas(),!this.canvas)return;const s=t.renderer(),[r,n]=[s.canvas().width,s.canvas().height],a=Math.ceil(r/this.canvas.width)+1,h=Math.ceil(n/this.canvas.height)+1,o=s.context();var c,d,l;const w=(c=this.scroll-this.scrollSpeed,d=this.scroll,((l=i)<=0?c:l>=1?d:c+l*(d-c))%this.canvas.height);for(let t=0;t<h;++t)for(let e=0;e<a;++e)o.drawImage(this.canvas,Math.floor(e*this.canvas.width-w),Math.floor(t*this.canvas.height-w))}}const x=JSON.parse('{"title":{"x":1,"y":1,"w":644,"h":156},"arrowRight":{"x":1,"y":161,"w":12,"h":22},"arrowLeft":{"x":19,"y":161,"w":12,"h":22},"arrowUp":{"x":33,"y":161,"w":20,"h":14},"arrowDown":{"x":33,"y":177,"w":20,"h":14},"starWhiteEmpty":{"x":65,"y":161,"w":14,"h":12},"starWhiteFilled":{"x":81,"y":161,"w":14,"h":12},"starBlackEmpty":{"x":65,"y":175,"w":14,"h":12},"starBlackFilled":{"x":81,"y":175,"w":14,"h":12}}');var f=r.t(x,2);const v=JSON.parse('{"wall":[{"x":0,"y":0,"w":16,"h":16},{"x":16,"y":0,"w":16,"h":16},{"x":32,"y":0,"w":16,"h":16},{"x":48,"y":0,"w":16,"h":16},{"x":64,"y":0,"w":16,"h":16},{"x":80,"y":0,"w":16,"h":16},{"x":96,"y":0,"w":16,"h":16},{"x":112,"y":0,"w":16,"h":16},{"x":0,"y":16,"w":16,"h":16},{"x":16,"y":16,"w":16,"h":16},{"x":32,"y":16,"w":16,"h":16},{"x":48,"y":16,"w":16,"h":16},{"x":64,"y":16,"w":16,"h":16},{"x":80,"y":16,"w":16,"h":16},{"x":96,"y":16,"w":16,"h":16},{"x":112,"y":16,"w":16,"h":16}],"floor":[{"x":0,"y":32,"w":16,"h":16},{"x":0,"y":32,"w":16,"h":16},{"x":0,"y":32,"w":16,"h":16},{"x":0,"y":32,"w":16,"h":16}],"dropzone":[{"x":16,"y":32,"w":16,"h":16},{"x":16,"y":32,"w":16,"h":16},{"x":16,"y":32,"w":16,"h":16},{"x":16,"y":32,"w":16,"h":16}],"player":{"x":0,"y":96,"w":16,"h":16},"crate":[{"x":0,"y":112,"w":16,"h":16},{"x":16,"y":112,"w":16,"h":16}]}');var L,k=r.t(v,2);class b{constructor(){this.x=0,this.y=0,this.picture=null,this.slice=new h(0,0,0,0)}draw(t,e,i){this.picture&&t.drawSprite(this.picture,this.slice,e,i)}}!function(t){t[t.None=0]="None",t[t.Floor=1]="Floor",t[t.Wall=2]="Wall",t[t.Dropzone=3]="Dropzone"}(L||(L={}));class S{constructor(t,e,i,s){this.x=0,this.y=0,this.dirty=!0,this.tokens=[],this.width=t,this.height=e,this.tiles=new Array(t*e),this.tiles.fill(L.None),this.displayTiles=new Array(t*e),this.displayTiles.fill(null),this.picture=i,this.slices=s,this.tileWidth=s.wall[0].w,this.tileHeight=s.wall[0].h}neighborBits(t,e){let i=0;return this.tile(t,e-1)===L.Wall&&(i+=1),this.tile(t+1,e)===L.Wall&&(i+=2),this.tile(t,e+1)===L.Wall&&(i+=4),this.tile(t-1,e)===L.Wall&&(i+=8),i}updateDisplayTiles(){this.dirty=!1;let t=0;for(let e=0;e<this.height;++e)for(let i=0;i<this.width;++i){switch(this.tile(i,e)){case L.None:this.displayTiles[t]=null;break;case L.Floor:this.displayTiles[t]=this.slices.floor[0];break;case L.Dropzone:this.displayTiles[t]=this.slices.dropzone[0];break;case L.Wall:{const s=this.neighborBits(i,e);this.displayTiles[t]=this.slices.wall[s];break}}++t}}posToIndex(t,e){return t+e*this.width}tile(t,e){return t<0||t>=this.width||e<0||e>=this.height?L.None:this.tiles[this.posToIndex(t,e)]}setTile(t,e,i){if(t<0||t>=this.width||e<0||e>=this.height)throw new Error("Tile coordinates out of range");this.tiles[this.posToIndex(t,e)]=i,this.dirty=!0}draw(t){this.dirty&&this.updateDisplayTiles();let e=0;for(let i=0;i<this.height;++i)for(let s=0;s<this.width;++s){const r=this.displayTiles[e];r&&t.drawSprite(this.picture,r,this.x+s*this.tileWidth,this.y+i*this.tileHeight),++e}for(const e of this.tokens){const i=e.x*this.tileWidth+this.x,s=e.y*this.tileHeight+this.y;e.draw(t,i,s)}}}const T=f,C=k;class E{constructor(){this.picture=new a("res/TitleAtlas.png"),this.previewPicture=new a("res/PreviewAtlas.png"),this.ticks=0,this.previewBoard=null,this.previewBoard=new S(16,16,this.previewPicture,C);for(let t=0;t<16;++t)for(let e=0;e<16;++e)if(Math.random()<.4)this.previewBoard.setTile(e,t,L.Wall);else if(this.previewBoard.setTile(e,t,L.Floor),Math.random()<.1){const i=new b;i.x=e,i.y=t,i.picture=this.previewPicture,i.slice=C.crate[0],this.previewBoard.tokens.push(i)}}tick(t,e){this.ticks++}drawPreviewBoard(t){if(this.previewBoard){const e=t.context();e.strokeStyle="rgb(0, 0, 0, 0.15)",e.fillStyle="rgb(0, 0, 0, 0.15)",e.fillRect(464,304,496,336),e.strokeRect(464.5,304.5,496,336),this.previewBoard.x=712-this.previewBoard.width*this.previewBoard.tileWidth/2,this.previewBoard.y=472-this.previewBoard.height*this.previewBoard.tileHeight/2,this.previewBoard.draw(t)}}draw(t,e,i){const s=t.renderer(),r=s.canvas().width;s.drawSprite(this.picture,T.title,(r-T.title.w)/2,32),this.drawPreviewBoard(s)}}window.onload=function(){const t=new g("game_surface"),e=t.input();e.addAction("left",["ArrowLeft","KeyA"]),e.addAction("right",["ArrowRight","KeyD"]),e.addAction("up",["ArrowUp","KeyW"]),e.addAction("down",["ArrowDown","KeyS"]),t.setScene((()=>function(){const t=new l,e=new m(.25),i=new E;return t.addLogic(e),t.addLogic(i),t}())),t.run()}})();